<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-icons/iron-icons.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <lens-data-find-replace></lens-data-find-replace>

@demo
-->
<dom-module id="lens-data-find-replace">

  <style>
    :host {
      display: block;
      box-sizing: border-box;
    }

    .author img {
      float: left;
      margin-right: 5px;
      max-height: 100px;
      max-width: 100px;
    }

    iron-selector {
      min-height: 10px;
      display: inline-block;
      max-height: 123px;
      overflow-y: scroll; 
    }

    iron-selector .col {
      padding: 1px;
      border: 1px solid #EEE;
    }
    iron-selector .iron-selected {
      background-color: #ccc;

    }
    label {
      display: block;
      margin-top: 5px;
    }

    .progress {
      background-color: #eee;
      border-radius: 3px;
      padding: 3px;
      font-weight: 600;
      margin: 10px auto;
    }
  </style>

  <template>

    <label>Find:</label>
    <input style="border: 2px solid #eee; padding: 3px;" is="iron-input" bind-value="{{find}}" value="{{find}}" type="text">

    <label>Replace with:</label>
    <input style="border: 2px solid #eee; padding: 3px;" is="iron-input" bind-value="{{replaceWith}}" value="{{replaceWith}}">

    <label>Search in:</label>
    <iron-selector id="search_in" selected-values="{{selectedLabels}}" attr-for-selected="label"  multi="true" on-iron-select="_calculateOutput" on-iron-deselect="_calculateOutput">
      <template is="dom-repeat" items="{{_dataAttributes}}" as="attr">
        <div class="col" label="{{attr}}">{{attr}}</div>
      </template>
    </iron-selector>

    <label>
      <template is="dom-if" if="{{!caseSensitive}}"> 
        <iron-icon on-tap="toggleCaseSensitive" icon="check-box-outline-blank" data-target="caseSensitive" data-value="1"></iron-icon> 
      </template>
      <template is="dom-if" if="{{caseSensitive}}"> 
        <iron-icon on-tap="toggleCaseSensitive" icon="check-box" data-target="caseSensitive" data-value=""></iron-icon> 
      </template>
      Case Sensitive?
    </label>

    <label>
      <template is="dom-if" if="{{!exactMatchesOnly}}"> 
        <iron-icon on-tap="toggleExactMatchesOnly" icon="check-box-outline-blank" data-target="exactExactMatchesOnly" data-value="1"></iron-icon> 
      </template>
      <template is="dom-if" if="{{exactMatchesOnly}}"> 
        <iron-icon on-tap="toggleExactMatchesOnly" icon="check-box" data-target="exactMatchesOnly" data-value=""></iron-icon> 
      </template>
      Exact Matches Only?
    </label>

    <template is="dom-if" if="{{_matches > 1}}">
      <div class="progress">"{{find}}" has been replaced with "{{replaceWith}}" in {{_matches}} places.</div>
    </template>

    <template is="dom-if" if="{{_matches === 1}}">
      <div class="progress">"<span>{{find}}</span>" has been replaced with "<span>{{replaceWith}}</span>" in <span>{{_matches}}</span> place.</div>
    </template>

  </template>

</dom-module>

<script src="../lodash/lodash.js"></script>

<script>

  Polymer({
    is: 'lens-data-find-replace',
    properties: {
      /**
       * Input data, where each item in the array is an object
       * @type Array
       * @default []
       */
      input: {
        type: Array,
        value: [],
        observer: '_inputChanged'
      },

      /**
       * Output data, where each item in the array is an object
       * @type Array
       * @default []
       */
      output: {
        type: Array,
        value: [],
        notify: true,
        readOnly: true,
        observer: '_outputChanged'
      },

      /**
       * The term to be searched in `input` data
       * 
       * @type String
       * @default ''
       */
      find: {
        type: String,
        value: '',
        observer: '_calculateOutput'
      },

      /**
       * The term to replace matches for `find` in `input` data
       * 
       * @type String
       * @default ''
       */
      replaceWith: {
        type: String,
        value: '',
        observer: '_calculateOutput'
      },

      /**
       * If true, the `find` term will be treated as case-sensitive
       * @type Boolean
       * @default true
       */
      caseSensitive: {
        type: Boolean,
        value: true,
        observer: '_calculateOutput'
      },

      /**
       * If true, partial matches will not be replaced
       * @type Boolean
       * @default true
       */
      exactMatchesOnly: {
        type: Boolean,
        value: true,
        observer: '_calculateOutput'
      },

      /**
       * The domain for the search. These are columns / keys to searched within `input` data
       * 
       * @type Array
       * @default []
       */
      selectedLabels: {
        type: Array,
        value: [],
        notify: true      
      },

      _matches: {
        type: Number,
        value: 0,
        notify: true

      }

    },
    listeners: {
      
    },

    // Element Lifecycle
    ready: function() {
      // `ready` is called after all elements have been configured, but
      // propagates bottom-up. This element's children are ready, but parents
      // are not.
      //
      // This is the point where you should make modifications to the DOM (when
      // necessary), or kick off any processes the element wants to perform.
    },

    attached: function() {
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).
    },

    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    },

    // Element Behavior

    /**
     * Toggles the boolean value of 'caseSensitive'
     */
    toggleCaseSensitive: function(e, detail){
      this.caseSensitive = Boolean(e.target.dataset.value);
    },

    /**
     * Toggles the boolean value of 'exactMatchesOnly'
     */
    toggleExactMatchesOnly: function(e, detail){
      this.exactMatchesOnly = Boolean(e.target.dataset.value);
    },

    /**
     * `output` is calculated by replaced all the matches in `input`
     * 
     * @return {[type]} [description]
     */
    _calculateOutput: function(){
      var self = this;
        self._matches = 0;
        if (self.caseSensitive){
          var pattern = self.exactMatchesOnly ? new RegExp("^"+self.find+"$") : new RegExp(self.find, "g");
        } else {
          var pattern = self.exactMatchesOnly ? new RegExp("^"+self.find+"$", "i") : new RegExp(self.find.toLowerCase(), "ig");
        }

        if (self.input && self.input.length && self.find && self.selectedLabels && self.selectedLabels.length){

          self.output = self.input.map(function(row, index){
            var newRow = _.clone(row);
            

            self.selectedLabels.forEach(function(col){
              var value = row[col];
              if (pattern.test(value)){

                newRow[col] = value.replace(pattern, self.replaceWith);
                self._matches++;
              } 
              

            })
            return newRow;
          })     
        }

    },

    // Observers
    _inputChanged: function(newValue, oldValue){
      var self = this;
        var firstItem = self.input[0];
        if(!firstItem) {
          return;
        }
        var attributes = Object.keys(firstItem);
        
        if(JSON.stringify(self._dataAttributes) !== JSON.stringify(attributes) ) {
          self._dataAttributes = attributes;
        }

        self._calculateOutput();

    },

    /**
     * The `lens-output-changed` event is fired whenever `_outputChanged` is called.
     * 
     * @event lens-output-changed
     */
    _outputChanged: function(newValue, oldValue){
      this.fire('lens-output-changed', this);
    }

  });

</script>
